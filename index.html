<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>駒場祭POS（ツケ対応・未払い合計つき完全版）</title>
<style>
  :root{--bg:#fafafa;--card:#fff;--border:#e5e7eb;--muted:#6b7280;--ink:#111}
  *{box-sizing:border-box;font-family:system-ui,-apple-system,"Noto Sans JP",Segoe UI,Roboto,Helvetica,Arial}
  body{margin:0;background:var(--bg);color:var(--ink)}
  header{position:sticky;top:0;z-index:5;background:#fff;border-bottom:1px solid var(--border);padding:8px 12px}
  main{padding:10px;max-width:1100px;margin:0 auto;padding-bottom:160px}
  h1{margin:0;font-size:18px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  input,select,button{border:1px solid var(--border);border-radius:10px;padding:8px 10px;background:#fff}
  button{cursor:pointer}
  button.primary{background:#111;color:#fff;border-color:#000}
  button.ghost{background:#f3f4f6}
  button.danger{background:#fff;border-color:#ef4444;color:#b91c1c}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:12px;margin-top:12px}
  .muted{color:var(--muted);font-size:12px}
  .tag{border:1px solid var(--border);border-radius:999px;padding:0 8px;font-size:11px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:8px}
  .tile{display:flex;flex-direction:column;gap:6px;background:#fff;border:1px solid var(--border);border-radius:12px;padding:12px;align-items:flex-start}
  .name{font-weight:700}
  .footbar{position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:1px solid var(--border);padding:8px 12px;z-index:10}
  .footbar .row{justify-content:space-between}
  .list-row{display:flex;gap:8px;align-items:center;justify-content:space-between;border-bottom:1px solid #eee;padding:6px 0;flex-wrap:wrap}
  table{width:100%;border-collapse:collapse}
  th,td{padding:6px;border-bottom:1px solid #eee;text-align:right;font-size:13px}
  th:first-child,td:first-child{text-align:left}
  .pill{border-radius:999px;background:#f3f4f6;padding:2px 8px;font-size:12px}
  #syncLog{white-space:pre-wrap;background:#111;color:#0f0;padding:8px;margin:8px;border-radius:8px;max-height:240px;overflow:auto}
  .totalbox{display:flex;justify-content:space-between;align-items:center;background:#f9fafb;border:1px solid var(--border);border-radius:12px;padding:8px 12px}
</style>
</head>
<body>
<header>
  <div class="row" style="justify-content:space-between">
    <h1>駒場祭POS</h1>
    <div class="row">
      <input id="goal" inputmode="numeric" placeholder="売上目標(円)" style="max-width:150px">
      <input id="lowStock" inputmode="numeric" placeholder="在庫アラート" style="max-width:120px">
      <input id="cashier" placeholder="担当者" style="max-width:120px">
    </div>
  </div>
  <div class="row" style="margin-top:6px">
    <input id="search" placeholder="商品検索 (例: じゃが / SKU)" style="min-width:180px;flex:1">
    <select id="catFilter"><option value="">すべてのカテゴリ</option></select>
    <!-- 表示日切替 -->
    <input id="viewDate" type="date" style="max-width:160px">
    <button id="viewToday">今日</button>
  </div>
</header>

<main>
  <!-- 商品 -->
  <section class="card">
    <div class="row" style="justify-content:space-between">
      <div style="font-weight:600">商品（タップで追加）</div>
      <div class="row">
        <button id="newItemBtn">新規商品</button>
        <button id="resetDemo">デモ商品</button>
      </div>
    </div>
    <div id="newForm" class="row" style="display:none;margin-top:8px">
      <input id="newName" placeholder="商品名">
      <input id="newPrice" inputmode="numeric" placeholder="単価(円)" style="max-width:120px">
      <input id="newStock" inputmode="numeric" placeholder="在庫" style="max-width:120px">
      <input id="newSku" placeholder="SKU" style="max-width:140px">
      <input id="newCat" placeholder="カテゴリ (例: フード)" style="max-width:140px">
      <button id="addItem" class="primary">追加</button>
    </div>
    <div id="catalog" class="grid" style="margin-top:8px"></div>
  </section>

  <!-- カート -->
  <section class="card">
    <div style="font-weight:600">カート</div>
    <div id="cartLines"></div>
    <div class="row" style="margin-top:8px">
      <span class="pill">注文全体の割引</span>
      <label class="muted">％</label>
      <input id="discountPct" inputmode="numeric" placeholder="10" style="max-width:90px">
      <label class="muted">円</label>
      <input id="discountYen" inputmode="numeric" placeholder="50" style="max-width:110px">
    </div>
    <!-- ツケ設定 -->
    <div class="row" style="margin-top:8px">
      <label class="row">
        <input type="checkbox" id="creditFlag"> ツケ（部員向け）
      </label>
      <input id="creditWho" placeholder="氏名 / 学籍など" style="max-width:220px">
      <select id="creditStatus">
        <option value="unpaid">未払い</option>
        <option value="paid">支払い済み</option>
      </select>
    </div>
    <div class="muted" style="margin-top:4px">※ツケにチェックすると「掛売」で記録。在庫は減ります</div>
  </section>

  <!-- サマリ（表示日） -->
  <section class="card">
    <div style="font-weight:600">サマリ（表示日） <span id="todayS"></span></div>
    <div id="summary"></div>
  </section>

  <!-- 商品別会計（表示日） -->
  <section class="card">
    <div class="row" style="justify-content:space-between">
      <div style="font-weight:600">商品別会計（表示日）</div>
      <div class="row"><button id="exportItemAgg">商品別CSV</button></div>
    </div>
    <div style="overflow:auto">
      <table>
        <thead><tr><th>商品</th><th>カテゴリ</th><th>売上数量</th><th>売上金額</th><th>平均単価</th><th>在庫</th></tr></thead>
        <tbody id="itemAggTable"></tbody>
      </table>
    </div>
  </section>

  <!-- ツケ（未払い） -->
  <section class="card">
    <div class="row" style="justify-content:space-between">
      <div style="font-weight:600">ツケ（掛売）管理</div>
      <div class="row">
        <button id="exportCredits">ツケCSV</button>
      </div>
    </div>
    <div class="totalbox" style="margin:8px 0">
      <div><b>未払い合計</b></div>
      <div id="creditTotal" style="font-weight:800">¥0</div>
    </div>
    <div style="overflow:auto">
      <table>
        <thead>
          <tr>
            <th>氏名</th>
            <th>未払い金額</th>
            <th>件数</th>
            <th>明細</th>
            <th>操作</th>
          </tr>
        </thead>
        <tbody id="creditTable"></tbody>
      </table>
    </div>
  </section>

  <!-- CSV / 連携 -->
  <section class="card">
    <div class="row">
      <button id="exportTx">取引CSV</button>
      <button id="exportItems">商品CSV</button>
      <input type="file" id="importItems" style="display:none">
      <button onclick="document.getElementById('importItems').click()">商品CSV読込</button>
      <button id="exportLowStock">在庫アラートCSV</button>
      <button id="syncGoogle">Googleシート同期</button>
      <label class="row"><input type="checkbox" id="autoSync"> 自動同期</label>
      <button id="wipeTx" class="danger">取引 全消去</button>
      <button id="wipeAll" class="danger">すべて初期化</button>
    </div>
    <div class="muted" style="margin-top:6px">商品CSV列：<code>name,price,stock,sku,cat,dPct,dYen</code></div>
  </section>

  <pre id="syncLog">【同期ログ】ここに詳細が出ます</pre>
</main>

<!-- フッター会計バー -->
<div class="footbar">
  <div class="row">
    <div class="row" style="gap:12px">
      <span class="muted">支払い</span>
      <select id="pay"><option>現金</option><option>QRコード</option><option>カード</option><option>その他</option></select>
      <span class="muted">合計</span><span id="cartTotal" style="font-weight:800;font-size:18px">¥0</span>
    </div>
    <div class="row">
      <button id="commit" class="primary">販売記録</button>
      <button id="refund">返金として記録</button>
      <button id="clear" class="ghost">カート空に</button>
      <label class="row" style="margin-left:8px"><input type="checkbox" id="printAfterSale"> 会計後レシート</label>
    </div>
  </div>
</div>

<script>
/* ========= 定数/ユーティリティ ========= */
const LS_I="komaba_pos_items_cat_v4";
const LS_T="komaba_pos_txs_cat_v4";
const LS_CASH="komaba_pos_cashier";
const LS_GOAL="komaba_pos_goal";
const LS_LOW="komaba_pos_lowstock";
const WKEY="komaba_pos_gas_webhook_v1";
const LS_AUTOSYNC="komaba_pos_autosync_v1";
function gid(id){return document.getElementById(id)}
function read(k,d){try{return JSON.parse(localStorage.getItem(k))??d}catch{return d}}
function write(k,v){localStorage.setItem(k,JSON.stringify(v))}
function jpy(n){return "¥"+(Math.round(n)||0).toLocaleString("ja-JP")}
function esc(s){return String(s??"").replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[m]))}
function logSync(t){gid("syncLog").textContent="【同期ログ】\n"+t}
function yyyyMMdd(d){return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`}
function selectedDate(){const el=gid("viewDate");if(el&&el.value){const[a,b,c]=el.value.split("-").map(Number);return new Date(a,b-1,c)}return new Date()}
function isSameDayTs(ts,d){const x=new Date(ts);return x.getFullYear()===d.getFullYear()&&x.getMonth()===d.getMonth()&&x.getDate()===d.getDate()}
async function fetchWithTimeout(input,init={},ms=15000){const ctrl=new AbortController();const id=setTimeout(()=>ctrl.abort(),ms);try{return await fetch(input,{...init,signal:ctrl.signal})}finally{clearTimeout(id)}}

/* ========= 要素 ========= */
const els={
  goal:gid("goal"),low:gid("lowStock"),cashier:gid("cashier"),
  search:gid("search"),catFilter:gid("catFilter"),
  catalog:gid("catalog"),cartLines:gid("cartLines"),cartTotal:gid("cartTotal"),
  discountPct:gid("discountPct"),discountYen:gid("discountYen"),
  pay:gid("pay"),commit:gid("commit"),refund:gid("refund"),clearBtn:gid("clear"),
  newItemBtn:gid("newItemBtn"),newForm:gid("newForm"),addItem:gid("addItem"),
  newName:gid("newName"),newPrice:gid("newPrice"),newStock:gid("newStock"),newSku:gid("newSku"),newCat:gid("newCat"),
  resetDemo:gid("resetDemo"),
  todayS:gid("todayS"),summary:gid("summary"),itemAggTable:gid("itemAggTable"),
  exportTx:gid("exportTx"),exportItems:gid("exportItems"),importItems:gid("importItems"),exportItemAgg:gid("exportItemAgg"),
  exportLowStock:gid("exportLowStock"),
  syncGoogle:gid("syncGoogle"),autoSync:gid("autoSync"),
  viewDate:gid("viewDate"),viewToday:gid("viewToday"),
  printAfterSale:gid("printAfterSale"),
  wipeTx:gid("wipeTx"),wipeAll:gid("wipeAll"),
  creditFlag:gid("creditFlag"),creditWho:gid("creditWho"),creditStatus:gid("creditStatus"),
  exportCredits:gid("exportCredits"),creditTable:gid("creditTable"),creditTotal:gid("creditTotal")
};

/* ========= 状態 ========= */
let items=read(LS_I,[
  {id:crypto.randomUUID(),name:"じゃがバター",price:400,stock:200,sku:"JGBTR",cat:"フード",dPct:0,dYen:0},
  {id:crypto.randomUUID(),name:"塩バター（トッピング）",price:50,stock:300,sku:"TOP-SALT",cat:"フード",dPct:0,dYen:0},
  {id:crypto.randomUUID(),name:"コーンバター",price:450,stock:150,sku:"CORN",cat:"フード",dPct:0,dYen:0},
  {id:crypto.randomUUID(),name:"ドリンク（お茶）",price:150,stock:120,sku:"TEA",cat:"ドリンク",dPct:0,dYen:0}
]);
let txs=read(LS_T,[]);
let cart=[];

/* ========= 入力復元 ========= */
els.cashier.value=read(LS_CASH,"");
els.goal.value=(read(LS_GOAL,"")||"");
els.low.value=(read(LS_LOW,"")||"");
els.cashier.addEventListener("input",()=>write(LS_CASH,els.cashier.value));
els.goal.addEventListener("input",()=>write(LS_GOAL,(els.goal.value||"").replace(/[^0-9]/g,"")));
els.low.addEventListener("input",()=>write(LS_LOW,(els.low.value||"").replace(/[^0-9]/g,"")));
els.search.addEventListener("input",renderCatalog);
els.catFilter.addEventListener("change",renderCatalog);

/* ========= 商品 ========= */
function refreshCatOptions(){const cats=[...new Set(items.map(i=>i.cat).filter(Boolean))];els.catFilter.innerHTML='<option value="">すべてのカテゴリ</option>'+cats.map(c=>`<option>${esc(c)}</option>`).join('')}
function renderCatalog(){
  const q=(els.search.value||"").toLowerCase(); const catSel=els.catFilter.value||""; const threshold=Number(els.low.value||0);
  els.catalog.innerHTML="";
  items.filter(it=>{if(catSel && it.cat!==catSel) return false; if(!q) return true; return (it.name+" "+(it.sku||"")).toLowerCase().includes(q)})
    .forEach((it,idx)=>{
      const soldOut=it.stock<=0, low=!soldOut&&threshold>0&&it.stock<=threshold;
      const t=document.createElement("div"); t.className="tile"; t.style.opacity=soldOut?0.6:1;
      t.innerHTML=`
        <div class="name">${esc(it.name)}</div>
        <div class="muted">${jpy(it.price)} / 在庫:${it.stock}
          ${low?'<span class="tag" style="margin-left:6px;border-color:#f59e0b;color:#b45309">残りわずか</span>':''}
          ${soldOut?'<span class="tag" style="margin-left:6px;border-color:#ef4444;color:#ef4444">売切れ</span>':''}
        </div>
        <div class="muted" style="font-size:11px">${it.cat?('カテゴリ:'+esc(it.cat)+'　'):""}${it.sku?('SKU:'+esc(it.sku)):""}</div>
        <div class="row" style="margin-top:6px">
          <button class="primary" data-add="${it.id}" ${soldOut?'disabled':''}>＋ 追加</button>
          <span class="muted">デフォ割</span>
          <input class="small" style="max-width:80px" inputmode="numeric" placeholder="% 例:10" data-dpct="${it.id}" value="${it.dPct||''}">
          <input class="small" style="max-width:100px" inputmode="numeric" placeholder="円 例:50" data-dyen="${it.id}" value="${it.dYen||''}">
          <button data-edit="${it.id}">編集</button>
          <button class="danger" data-del="${it.id}">削除</button>
        </div>`;
      if(!soldOut) t.querySelector(`[data-add="${it.id}"]`).addEventListener("click",()=>addToCart(it.id));
      t.querySelector(`[data-dpct="${it.id}"]`).addEventListener("input",e=>{items[idx].dPct=Number((e.target.value||"").replace(/[^0-9]/g,""));write(LS_I,items)});
      t.querySelector(`[data-dyen="${it.id}"]`).addEventListener("input",e=>{items[idx].dYen=Number((e.target.value||"").replace(/[^0-9]/g,""));write(LS_I,items)});
      t.querySelector(`[data-edit="${it.id}"]`).addEventListener("click",()=>editItem(it.id));
      t.querySelector(`[data-del="${it.id}"]`).addEventListener("click",()=>deleteItem(it.id));
      els.catalog.appendChild(t);
    });
}
function editItem(id){
  const i=items.findIndex(x=>x.id===id); if(i<0) return;
  const it=items[i];
  const name=prompt("商品名",it.name); if(name===null) return;
  const price=Number(String(prompt("単価(円)",it.price)).replace(/[^0-9]/g,"")); if(isNaN(price)) return alert("価格が不正");
  const stock=Number(String(prompt("在庫",it.stock)).replace(/[^0-9]/g,"")); if(isNaN(stock)) return alert("在庫が不正");
  const sku=prompt("SKU",it.sku||""); if(sku===null) return;
  const cat=prompt("カテゴリ（例: フード/ドリンク）",it.cat||""); if(cat===null) return;
  items[i]={...it,name,price,stock,sku,cat};
  cart=cart.map(l=>l.id===id?{...l,name,price,sku,cat}:l);
  write(LS_I,items); renderCatalog(); renderCart(); renderItemAgg(); refreshCatOptions();
}
function deleteItem(id){
  const it=items.find(i=>i.id===id); if(!it) return;
  if(!confirm(`『${it.name}』を削除します。よろしいですか？`)) return;
  items=items.filter(i=>i.id!==id); cart=cart.filter(l=>l.id!==id);
  write(LS_I,items); renderCatalog(); renderCart(); renderItemAgg(); refreshCatOptions();
}

/* ========= カート ========= */
function addToCart(id){
  const it=items.find(i=>i.id===id); if(!it) return;
  const ex=cart.find(l=>l.id===id); if(ex){ex.qty+=1}else{
    cart.push({id:it.id,name:it.name,price:it.price,sku:it.sku||"",cat:it.cat||"",qty:1,lineDiscPct:Number(it.dPct||0),lineDiscYen:Number(it.dYen||0)});
  }
  renderCart();
}
function lineDiscountedTotal(l){
  const base=l.price*l.qty, pct=Math.max(0,Math.min(100,Number(l.lineDiscPct)||0)), yen=Math.max(0,Number(l.lineDiscYen)||0);
  const disc=Math.min(base,Math.floor(base*pct/100)+yen); return base-disc;
}
function totals(){
  const subAfterLine=cart.reduce((s,l)=>s+lineDiscountedTotal(l),0);
  const orderPct=Math.max(0,Math.min(100,Number((els.discountPct?.value||"").replace(/[^0-9]/g,""))||0));
  const orderYen=Math.max(0,Number((els.discountYen?.value||"").replace(/[^0-9]/g,""))||0);
  const orderDisc=Math.min(subAfterLine,Math.floor(subAfterLine*orderPct/100)+orderYen);
  const total=Math.max(0,subAfterLine-orderDisc);
  return {subAfterLine,orderDisc,total,orderPct,orderYen};
}
function renderCart(){
  els.cartLines.innerHTML="";
  cart.forEach((l,i)=>{
    const row=document.createElement("div"); row.className="list-row";
    row.innerHTML=`
      <div><b>${esc(l.name)}</b> <span class="muted">(${jpy(l.price)})</span> <span class="muted">[${esc(l.cat||"-")}]</span></div>
      <div class="row">
        <button data-dec="${i}">−</button><span>${l.qty}</span><button data-inc="${i}">＋</button>
        <button data-del="${i}">削除</button>
      </div>
      <div class="row" style="width:100%">
        <span class="muted">商品割引</span>
        <input data-pct="${i}" inputmode="numeric" placeholder="% 例:10" style="max-width:90px" value="${l.lineDiscPct||""}">
        <input data-yen="${i}" inputmode="numeric" placeholder="円 例:50" style="max-width:110px" value="${l.lineDiscYen||""}">
        <span style="margin-left:auto">小計: <b>${jpy(lineDiscountedTotal(l))}</b></span>
      </div>`;
    els.cartLines.appendChild(row);
  });
  els.cartLines.querySelectorAll("[data-inc]").forEach(b=>b.addEventListener("click",()=>{const i=+b.dataset.inc;cart[i].qty++;renderCart()}));
  els.cartLines.querySelectorAll("[data-dec]").forEach(b=>b.addEventListener("click",()=>{const i=+b.dataset.dec;cart[i].qty--;if(cart[i].qty<=0)cart.splice(i,1);renderCart()}));
  els.cartLines.querySelectorAll("[data-del]").forEach(b=>b.addEventListener("click",()=>{const i=+b.dataset.del;cart.splice(i,1);renderCart()}));
  els.cartLines.querySelectorAll("[data-pct]").forEach(inp=>inp.addEventListener("input",()=>{const i=+inp.dataset.pct;cart[i].lineDiscPct=Number((inp.value||"").replace(/[^0-9]/g,""));renderCart()}));
  els.cartLines.querySelectorAll("[data-yen]").forEach(inp=>inp.addEventListener("input",()=>{const i=+inp.dataset.yen;cart[i].lineDiscYen=Number((inp.value||"").replace(/[^0-9]/g,""));renderCart()}));
  els.cartTotal.textContent=jpy(totals().total);
}
function clearCart(){cart=[];renderCart()}

/* ========= レシート ========= */
function printReceipt(tx){
  const d=new Date(tx.ts);
  const linesHtml=tx.lines.map(l=>{
    const base=l.price*l.qty, pct=Number(l.lineDiscPct||0), yen=Number(l.lineDiscYen||0);
    const disc=Math.min(base,Math.floor(base*pct/100)+yen), net=base-disc;
    return `<tr><td>${esc(l.name)} ×${l.qty}</td><td style="text-align:right">¥${net.toLocaleString("ja-JP")}</td></tr>`;
  }).join("");
  const html=`<html><head><meta charset="UTF-8"><style>body{font-family:system-ui;padding:16px}table{width:100%}td{padding:4px 0}</style></head>
  <body><h3>駒場祭POS レシート</h3>
  <div>${d.toLocaleString("ja-JP")} / ID:${tx.id.slice(-6)}</div>
  <div>支払い:${esc(tx.payment)} / 担当:${esc(tx.cashier||"-")}</div>
  ${tx.credit?.enabled?`<div>ツケ: ${esc(tx.credit.name||"-")}（${tx.credit.status==="unpaid"?"未払い":"支払い済み"}）</div>`:""}
  <hr><table>${linesHtml}</table><hr>
  <table><tr><td>小計(行割後)</td><td style="text-align:right">¥${tx.subtotal_after_line.toLocaleString("ja-JP")}</td></tr>
  <tr><td>会計割引</td><td style="text-align:right">−¥${tx.order_discount.toLocaleString("ja-JP")}</td></tr>
  <tr><td><b>合計</b></td><td style="text-align:right"><b>¥${tx.total.toLocaleString("ja-JP")}</b></td></tr></table>
  <script>window.print()`;
  const w=window.open("", "_blank", "width=420,height=640"); w.document.open(); w.document.write(html); w.document.close();
}

/* ========= 取引確定 ========= */
function commit(opts={refund:false}){
  if(!cart.length) return alert("カートが空です");
  if(!opts.refund){
    const ng=cart.filter(l=>{const it=items.find(i=>i.id===l.id);return it && l.qty>it.stock});
    if(ng.length){alert("在庫不足: "+ng.map(l=>l.name).join(", "));return;}
  }
  const t=totals();
  const onCredit=!!(els.creditFlag && els.creditFlag.checked);
  const tx={
    id:Date.now()+""+Math.random().toString(36).slice(2),
    ts:Date.now(),
    lines:JSON.parse(JSON.stringify(cart)),
    payment:onCredit?"掛売":els.pay.value,
    cashier:els.cashier.value||"",
    subtotal_after_line:t.subAfterLine,
    order_discount:opts.refund?0:t.orderDisc,
    order_discount_pct:opts.refund?0:t.orderPct,
    order_discount_yen:opts.refund?0:t.orderYen,
    total:(t.subAfterLine-(opts.refund?0:t.orderDisc))*(opts.refund?-1:1),
    refund:!!opts.refund, void:false,
    credit:{enabled:onCredit,name:(els.creditWho?.value||"").trim(),status:onCredit?(els.creditStatus?.value||"unpaid"):"none"},
    synced:false
  };
  if(!opts.refund){items=items.map(it=>{const l=cart.find(x=>x.id===it.id);return l?{...it,stock:Math.max(0,it.stock-l.qty)}:it})}
  else{items=items.map(it=>{const l=cart.find(x=>x.id===it.id);return l?{...it,stock:it.stock+l.qty}:it})}
  write(LS_I,items);
  txs=[tx,...txs]; write(LS_T,txs);
  clearCart(); els.discountPct.value=""; els.discountYen.value="";
  if(els.creditFlag) els.creditFlag.checked=false; if(els.creditWho) els.creditWho.value=""; if(els.creditStatus) els.creditStatus.value="unpaid";
  renderCatalog(); renderSummary(); renderItemAgg(); refreshCatOptions(); renderCreditList();
  if(els.printAfterSale && els.printAfterSale.checked){printReceipt(tx)}
  if(els.autoSync && els.autoSync.checked){syncNewTxs()}
}
els.commit.addEventListener("click",()=>commit());
els.refund.addEventListener("click",()=>commit({refund:true}));
els.clearBtn.addEventListener("click",clearCart);

/* ========= サマリ/商品別（表示日） ========= */
function renderSummary(){
  const target=selectedDate(); els.todayS.textContent=target.toLocaleDateString("ja-JP");
  const byPay=new Map(); let gross=0,count=0;
  for(const tx of txs){if(!isSameDayTs(tx.ts,target)||tx.void) continue; gross+=tx.total; count++; byPay.set(tx.payment,(byPay.get(tx.payment)||0)+tx.total)}
  els.summary.innerHTML="";
  for(const [k,v] of byPay.entries()){const div=document.createElement("div");div.className="row";div.style.justifyContent="space-between";div.innerHTML=`<span>${k}</span><span>${jpy(v)}</span>`;els.summary.appendChild(div)}
  const goal=Math.max(0,Number((els.goal?.value||"").replace(/[^0-9]/g,""))||0);
  const totalDiv=document.createElement("div");totalDiv.style.display="flex";totalDiv.style.justifyContent="space-between";totalDiv.style.fontWeight="700";
  totalDiv.innerHTML=`<span>合計</span><span>${jpy(gross)}</span>`;els.summary.appendChild(totalDiv);
  if(goal>0){const ratio=Math.min(1,gross/goal);const bar=document.createElement("div");bar.style.marginTop="8px";
    bar.innerHTML=`<div class="muted" style="display:flex;justify-content:space-between"><span>売上目標:${jpy(goal)}</span><span>${Math.floor(ratio*100)}%</span></div>
      <div style="height:10px;border:1px solid #ccc;border-radius:999px;overflow:hidden"><div style="height:100%;width:${ratio*100}%;background:#111"></div></div>`;
    els.summary.appendChild(bar)}
}
function buildItemAggSelectedDate(){
  const target=selectedDate(); const map=new Map();
  for(const it of items){map.set(it.id,{id:it.id,name:it.name,cat:it.cat||"",qty:0,amount:0,stock:it.stock})}
  for(const tx of txs){
    if(!isSameDayTs(tx.ts,target)||tx.void) continue;
    const lineTotals=tx.lines.map(l=>{
      const base=l.price*l.qty, pct=Number(l.lineDiscPct||0), yen=Number(l.lineDiscYen||0);
      const disc=Math.min(base,Math.floor(base*pct/100)+yen); return{id:l.id,qty:l.qty*(tx.refund?-1:1),subtotal:(base-disc)};
    });
    const sub=lineTotals.reduce((s,x)=>s+x.subtotal,0); const orderDisc=(tx.order_discount||0)*(tx.refund?-1:1);
    for(const lt of lineTotals){const share=sub>0?orderDisc*(lt.subtotal/sub):0; const net=lt.subtotal-share; const r=map.get(lt.id); r.qty+=lt.qty; r.amount+=net}
  }
  return Array.from(map.values());
}
function renderItemAgg(){
  const rows=buildItemAggSelectedDate(); els.itemAggTable.innerHTML="";
  rows.forEach(r=>{const avg=r.qty?Math.round(r.amount/r.qty):0; const tr=document.createElement("tr");
    tr.innerHTML=`<td>${esc(r.name)}</td><td>${esc(r.cat||"")}</td><td>${r.qty}</td><td>${jpy(Math.round(r.amount))}</td><td>${jpy(avg)}</td><td>${r.stock}</td>`;
    els.itemAggTable.appendChild(tr)});
}

/* ========= ツケ管理（集計/精算/CSV） ========= */
function renderCreditList(){
  if(!els.creditTable) return;
  // 名前ごとに未払い集計
  const map=new Map(); // name -> {amount,count,txids[]}
  txs.forEach(tx=>{
    if(tx.void || !tx.credit?.enabled || tx.credit.status!=="unpaid") return;
    const key=(tx.credit.name||"（未入力）").trim();
    const cur=map.get(key)||{amount:0,count:0,txids:[]};
    cur.amount+=tx.total; cur.count+=1; cur.txids.push(tx.id);
    map.set(key,cur);
  });
  // 合計
  let total=0; els.creditTable.innerHTML="";
  Array.from(map.entries()).sort((a,b)=>b[1].amount-a[1].amount).forEach(([name,info])=>{
    total+=info.amount;
    const tr=document.createElement("tr");
    const idsAttr=info.txids.join("|");
    tr.innerHTML=`
      <td>${esc(name)}</td>
      <td style="text-align:right">${jpy(info.amount)}</td>
      <td style="text-align:center">${info.count}</td>
      <td><button data-show="${idsAttr}">表示</button></td>
      <td><button class="primary" data-pay="${idsAttr}">全件 支払い済みに</button></td>`;
    els.creditTable.appendChild(tr);
  });
  els.creditTotal.textContent=jpy(total);

  // 明細表示
  els.creditTable.querySelectorAll("[data-show]").forEach(btn=>{
    btn.addEventListener("click",()=>{
      const ids=new Set(btn.getAttribute("data-show").split("|"));
      const rows=txs.filter(t=>ids.has(t.id)).map(t=>{
        const d=new Date(t.ts).toLocaleString("ja-JP");
        return `・${d}  ${t.lines.map(l=>`${l.name}×${l.qty}`).join(" + ")}  = ${jpy(t.total)}`;
      }).join("\n");
      alert(rows||"明細なし");
    });
  });
  // 一括支払い済み
  els.creditTable.querySelectorAll("[data-pay]").forEach(btn=>{
    btn.addEventListener("click",()=>{
      const ids=new Set(btn.getAttribute("data-pay").split("|"));
      if(!confirm("選択したツケを全て『支払い済み』にします。よろしいですか？")) return;
      txs=txs.map(t=>ids.has(t.id)?{...t,credit:{...t.credit,status:"paid"},synced:false}:t);
      write(LS_T,txs); renderCreditList(); renderSummary();
    });
  });
}
if(els.exportCredits){
  els.exportCredits.addEventListener("click",()=>{
    const rows=[["name","amount","count","tx_ids"]];
    const map=new Map();
    txs.forEach(tx=>{
      if(tx.void || !tx.credit?.enabled) return;
      const nm=(tx.credit.name||"（未入力）").trim();
      const cur=map.get(nm)||{amount:0,count:0,ids:[]};
      cur.amount+=tx.total; cur.count++; cur.ids.push(tx.id); map.set(nm,cur);
    });
    Array.from(map.entries()).forEach(([name,info])=>{
      rows.push([name,Math.round(info.amount),info.count,info.ids.join(" ")]);
    });
    const blob=new Blob([rows.map(r=>r.join(",")).join("\n")],{type:"text/csv"});
    const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="credits.csv"; a.click();
  });
}

/* ========= CSV/連携 ========= */
els.exportItems.addEventListener("click",()=>{
  const rows=[["name","price","stock","sku","cat","dPct","dYen"]];
  items.forEach(it=>rows.push([it.name,it.price,it.stock||0,it.sku||"",it.cat||"",it.dPct||0,it.dYen||0]));
  const blob=new Blob([rows.map(r=>r.join(",")).join("\n")],{type:"text/csv"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="items.csv"; a.click();
});
els.exportTx.addEventListener("click",()=>{
  const rows=[["tx_id","timestamp","date_jst","payment","cashier","subtotal_after_line","order_discount","order_discount_pct","order_discount_yen","total","refund","void","credit_enabled","credit_name","credit_status","line_item_id","item_name","sku","category","qty","unit_price","line_discount_pct","line_discount_yen","line_total"]];
  txs.forEach(tx=>{
    tx.lines.forEach(line=>{
      const base=line.price*line.qty, pct=Number(line.lineDiscPct||0), yen=Number(line.lineDiscYen||0);
      const disc=Math.min(base,Math.floor(base*pct/100)+yen), lineTotal=base-disc;
      rows.push([tx.id,new Date(tx.ts).toISOString(),new Date(tx.ts).toLocaleString("ja-JP"),tx.payment,tx.cashier,tx.subtotal_after_line,tx.order_discount,tx.order_discount_pct,tx.order_discount_yen,tx.total,tx.refund?1:0,tx.void?1:0,tx.credit?.enabled?1:0,tx.credit?.name||"",tx.credit?.status||"none",line.id,line.name,line.sku||"",line.cat||"",line.qty*(tx.refund?-1:1),line.price,pct,yen,lineTotal*(tx.refund?-1:1)]);
    });
  });
  const blob=new Blob([rows.map(r=>r.join(",")).join("\n")],{type:"text/csv"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="transactions.csv"; a.click();
});
els.importItems.addEventListener("change",e=>{
  const f=e.target.files[0]; if(!f)return;
  const reader=new FileReader();
  reader.onload=ev=>{
    const text=String(ev.target.result).trim(), lines=text.split(/\r?\n/).filter(Boolean), header=lines.shift().split(",");
    const iName=header.indexOf("name"),iPrice=header.indexOf("price"),iStock=header.indexOf("stock"),iSku=header.indexOf("sku"),iCat=header.indexOf("cat"),iDPct=header.indexOf("dPct"),iDYen=header.indexOf("dYen");
    items=lines.map(r=>{const c=r.split(",");return{id:crypto.randomUUID(),name:c[iName],price:Number(c[iPrice]),stock:Number(c[iStock]||0),sku:c[iSku]||"",cat:(iCat>=0?c[iCat]:""),dPct:Number(c[iDPct]||0),dYen:Number(c[iDYen]||0)}}).filter(x=>x.name&&!isNaN(x.price));
    write(LS_I,items); renderCatalog(); renderItemAgg(); refreshCatOptions();
  };
  reader.readAsText(f);
});
els.exportItemAgg.addEventListener("click",()=>{
  const rows=buildItemAggSelectedDate(); const csv=[["item_name","category","qty","amount","avg_price","stock"]];
  rows.forEach(r=>csv.push([r.name,r.cat||"",r.qty,Math.round(r.amount),r.qty?Math.round(r.amount/r.qty):0,r.stock]));
  const blob=new Blob([csv.map(r=>r.join(",")).join("\n")],{type:"text/csv"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="item_agg_selected_date.csv"; a.click();
});
els.exportLowStock.addEventListener("click",()=>{
  const threshold=Math.max(0,Number((els.low?.value||"").replace(/[^0-9]/g,""))||0);
  const rows=[["name","stock","sku","cat","price","note"]];
  items.filter(it=>it.stock<=threshold).forEach(it=>rows.push([it.name,it.stock,it.sku||"",it.cat||"",it.price,"補充要"]));
  const blob=new Blob([rows.map(r=>r.join(",")).join("\n")],{type:"text/csv"});
  const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="low_stock.csv"; a.click();
});

/* ========= 同期（手動/自動） ========= */
els.syncGoogle.addEventListener("click", async ()=>{
  let url=localStorage.getItem(WKEY)||""; url=prompt("（学内限定）Apps ScriptのWebhook URL（/exec）",url); if(!url) return; localStorage.setItem(WKEY,url);
  try{
    const ping=await fetchWithTimeout(url,{method:"GET",cache:"no-store"},8000); const pingText=await ping.text().catch(()=>"(no body)");
    logSync(`PING: HTTP ${ping.status}\n${pingText}`); if(!ping.ok){alert(`同期エラー: ${ping.status}`);return}
    const pending=txs.filter(t=>t.synced!==true);
    if(!pending.length){logSync("未同期の取引はありません");alert("未同期の取引はありません");return}
    const res=await fetchWithTimeout(url,{method:"POST",headers:{"Content-Type":"text/plain"},body:JSON.stringify({txs:pending})},15000);
    const text=await res.text().catch(()=>"(no body)"); logSync(`POST: HTTP ${res.status}\n${text}`);
    if(res.ok){const ids=new Set(pending.map(t=>t.id)); txs=txs.map(t=>ids.has(t.id)?{...t,synced:true}:t); write(LS_T,txs); alert(`同期完了（新規 ${pending.length} 件）`)}else{alert(`同期失敗 (${res.status})`)}
  }catch(e){alert("同期エラー: "+e.message); logSync("例外: "+e.message)}
});
async function syncNewTxs(){
  const url=localStorage.getItem(WKEY)||""; if(!url) return;
  const pending=txs.filter(t=>t.synced!==true); if(!pending.length) return;
  try{
    const res=await fetchWithTimeout(url,{method:"POST",headers:{"Content-Type":"text/plain"},body:JSON.stringify({txs:pending})},15000);
    const text=await res.text().catch(()=>"(no body)"); logSync(`自動同期: HTTP ${res.status}\n${text}`);
    if(res.ok){const ids=new Set(pending.map(t=>t.id)); txs=txs.map(t=>ids.has(t.id)?{...t,synced:true}:t); write(LS_T,txs)}
  }catch(e){logSync("自動同期 例外: "+e.message)}
}
els.autoSync.checked=read(LS_AUTOSYNC,false);
els.autoSync.addEventListener("change",()=>{write(LS_AUTOSYNC,els.autoSync.checked); if(els.autoSync.checked){txs=txs.map(t=>t.synced? t : {...t,synced:true}); write(LS_T,txs); logSync("自動同期ON（既存取引は同期済み扱い）")}else{logSync("自動同期OFF")}});

/* ========= 危険操作 ========= */
els.wipeTx.addEventListener("click",()=>{if(!confirm("取引データを全消去します。よろしいですか？"))return; txs=[]; write(LS_T,txs); cart=[]; renderCart(); renderSummary(); renderItemAgg(); renderCreditList(); logSync("取引データを消去")});
els.wipeAll.addEventListener("click",()=>{if(!confirm("商品と取引の全データを初期化します。よろしいですか？"))return; localStorage.removeItem(LS_T); localStorage.removeItem(LS_I); alert("初期化しました。再読み込みします"); location.reload()});

/* ========= 新規商品/デモ ========= */
els.newItemBtn.addEventListener("click",()=>{els.newForm.style.display=els.newForm.style.display==='none'?'flex':'none'});
els.addItem.addEventListener("click",()=>{
  const name=els.newName.value.trim(), price=Number((els.newPrice.value||"").replace(/[^0-9]/g,"")), stock=Number((els.newStock.value||"").replace(/[^0-9]/g,"")), sku=els.newSku.value.trim(), cat=els.newCat.value.trim();
  if(!name){alert("商品名は必須です");return}
  items=[{id:crypto.randomUUID(),name,price,stock,sku,cat,dPct:0,dYen:0},...items]; write(LS_I,items);
  els.newName.value=els.newPrice.value=els.newStock.value=els.newSku.value=els.newCat.value=""; renderCatalog(); refreshCatOptions();
});
els.resetDemo.addEventListener("click",()=>{
  if(!confirm("デモ商品を入れ直します（上書き）")) return;
  items=[
    {id:crypto.randomUUID(),name:"じゃがバター",price:400,stock:200,sku:"JGBTR",cat:"フード",dPct:0,dYen:0},
    {id:crypto.randomUUID(),name:"塩バター（トッピング）",price:50,stock:300,sku:"TOP-SALT",cat:"フード",dPct:0,dYen:0},
    {id:crypto.randomUUID(),name:"コーンバター",price:450,stock:150,sku:"CORN",cat:"フード",dPct:0,dYen:0},
    {id:crypto.randomUUID(),name:"ドリンク（お茶）",price:150,stock:120,sku:"TEA",cat:"ドリンク",dPct:0,dYen:0}
  ];
  write(LS_I,items); renderCatalog(); refreshCatOptions();
});

/* ========= 表示日 ========= */
(function(){const today=new Date(); els.viewDate.value=yyyyMMdd(today); els.todayS.textContent=today.toLocaleDateString("ja-JP")})();
els.viewDate.addEventListener("change",()=>{const d=selectedDate(); els.todayS.textContent=d.toLocaleDateString("ja-JP"); renderSummary(); renderItemAgg()});
els.viewToday.addEventListener("click",()=>{const t=new Date(); els.viewDate.value=yyyyMMdd(t); els.todayS.textContent=t.toLocaleDateString("ja-JP"); renderSummary(); renderItemAgg()});

/* ========= 初期描画 ========= */
function init(){renderCatalog(); renderCart(); renderSummary(); renderItemAgg(); refreshCatOptions(); renderCreditList()}
init();
</script>
</body>
</html>
